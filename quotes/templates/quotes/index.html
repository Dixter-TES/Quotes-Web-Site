{% extends "quotes/base.html" %} {% block title %}Цитаты - Главная{% endblock %}
{% block content %}
<a
    href="/editor"
    style="
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 10;
        text-decoration: none;
    "
    class="btn-sml"
    >Редактор цитат</a
>
<div class="content-container">
    <h1 id="question">Какая цитата вдохновит вас сегодня?</h1>
    <div id="quote">
        {% if not quote %}
        <p>
            Цитат пока нет. Пожалуйста, добавьте первую цитату через редактор.
        </p>
        {% else %}
        <p style="text-align: left; margin: 0.5rem; font-size: 1rem">
            Источник: {{ quote.source }}
        </p>
        <blockquote
            style="
                border: white solid 0.1rem;
                border-radius: 1rem;
                padding: 1.5rem;
                backdrop-filter: blur(2rem);
            "
        >
            <p style="font-size: 1.5rem; margin-bottom: 1rem">
                <i>„{{ quote.text }}“</i>
            </p>
            <p style="text-align: right; margin-bottom: 0; opacity: 0.5">
                — {{ quote.attribution }}
            </p>
        </blockquote>
        <div
            style="
                margin-top: 0.75rem;
                text-align: right;
                display: flex;
                align-items: center;
                justify-content: flex-end;
            "
        >
            <img
                id="likeBtn"
                src="/static/quotes/icons/thumb_up.svg"
                alt="Like"
                class="btn-reaction"
            />
            <span id="likes" style="margin-left: 0.4rem"
                >{{ quote.likes_count }}</span
            >
            <img
                id="dislikeBtn"
                src="/static/quotes/icons/thumb_down.svg"
                alt="Dislike"
                class="btn-reaction"
                style="margin-left: 1rem"
            />
            <span id="dislikes" style="margin-left: 0.4rem"
                >{{ quote.dislikes_count }}</span
            >
        </div>
        {% endif %}
    </div>

    <button class="btn" id="showBtn">Узнать сейчас</button>
    <div style="margin-top: 1rem">
        <a style="color: white; text-decoration: none" href="/rating"
            >Топ 10 лучших цитат</a
        >
    </div>
</div>

<footer>
    <p style="margin-bottom: 0.25rem; opacity: 0.5">
        Всего просмотров: {{ total_views }}
    </p>
</footer>

<script>
    const btn = document.getElementById("showBtn");
    const quote = document.getElementById("quote");
    const likeBtn = document.getElementById("likeBtn");
    const dislikeBtn = document.getElementById("dislikeBtn");

    const likesSpan = document.getElementById("likes");
    const dislikesSpan = document.getElementById("dislikes");

    let reaction = {% if reaction %}"{{ reaction }}"{% else %}null{% endif %};
    let likesCount = {{ quote.likes_count|default:0 }};
    let dislikesCount = {{ quote.dislikes_count|default:0 }};

    btn.addEventListener("click", () => {
        btn.classList.add("shrink");
        setTimeout(() => {
            btn.style.display = "none";
            quote.classList.add("visible");
        }, 300);
    });
    
    function react(quote_id, reaction_type) {
        fetch(`/api/quotes/${quote_id}/react/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `type=${encodeURIComponent(reaction_type)}`,
        })
        .then(response => response.json())
        .then(response => {
            reaction = response.reaction;
            likesCount = response.likes_count;
            dislikesCount = response.dislikes_count;

            updateReactionButtons();
        })
        .catch(error => {
            alert("Ошибка при установке оценки.");
        });
    }

    function updateReactionButtons() {
        if (reaction === "like") {
            likeBtn.style.backgroundColor = "green";
            dislikeBtn.style.backgroundColor = "transparent";
        } else if (reaction === "dislike") {
            dislikeBtn.style.backgroundColor = "red";
            likeBtn.style.backgroundColor = "transparent";
        } else {
            likeBtn.style.backgroundColor = "transparent";
            dislikeBtn.style.backgroundColor = "transparent";
        }

        likesSpan.textContent = likesCount;
        dislikesSpan.textContent = dislikesCount;
    }

    if (likeBtn && dislikeBtn) {
        likeBtn.addEventListener("click", () => {
            react({{ quote.id|default:0 }}, "like");
        });

        dislikeBtn.addEventListener("click", () => {
            react({{ quote.id|default:0 }}, "dislike");
        });

        updateReactionButtons();
    }
</script>
{% endblock %}
